{"version":3,"sources":["billing/billingApi.ts"],"names":[],"mappings":"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","file":"billingApi.js","sourcesContent":["/*\n * Mbed Cloud JavaScript SDK\n * Copyright Arm Limited 2018\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ConnectionOptions, CallbackFn, ListOptions } from \"../common/interfaces\";\nimport { Endpoints } from \"./endpoints\";\nimport { apiWrapper, dateToBillingMonth } from \"../common/functions\";\nimport { QuotaHistory } from \"./models/quotaHistory\";\nimport { mapQuotaHistory } from \"./models/quotaHistoryAdapter\";\nimport { ListResponse } from \"../common/listResponse\";\nimport { ServicePackageQuota, ServicePackagesResponse, ServicePackageQuotaHistoryResponse, BillingReportRawDataResponse } from \"../_api/billing\";\nimport { ServicePackage } from \"./models/servicePackage\";\nimport { mapPending, mapActive, mapPrevious } from \"./models/servicePackageAdapter\";\nimport { SDKError } from \"../common/sdkError\";\nimport { writeFile, createWriteStream } from \"fs\";\nimport { get as http_get } from \"superagent\";\n\nexport class BillingApi {\n    private readonly _endpoints: Endpoints;\n\n    /**\n     * The API can be initalized with a .env file in the wroking directory with the following values\n     *\n     * MBED_CLOUD_SDK_API_KEY=<Mbed Cloud Api Key>\n     *\n     * and optionally\n     *\n     * MBED_CLOUD_SDK_HOST=<your host> (defaults to https://api.us-east-1.mbedcloud.com)\n     *\n     * OR\n     * This API is initialized with [ConnectionOptions](../interfaces/connectionoptions.html).\n     *\n     * To create an instance of this API in [Node.js](https://nodejs.org):\n     *\n     * ```JavaScript\n     * var MbedCloudSDK = require(\"mbed-cloud-sdk\");\n     *\n     * var billing = new MbedCloudSDK.BillingApi({\n     *     apiKey: \"<Mbed Cloud API Key>\"\n     * });\n     * ```\n     *\n     * To create an instance of this API in the browser:\n     *\n     * ```html\n     * <script src=\"<mbed-cloud-sdk>/bundles/billing.min.js\"></script>\n     *\n     * <script>\n     *     var billing = new MbedCloudSDK.BillingApi({\n     *         apiKey: \"<Mbed Cloud API Key>\"\n     *     });\n     * </script>\n     * ```\n     * @param options Connection objects\n     */\n    constructor(options?: ConnectionOptions) {\n        this._endpoints = new Endpoints(options);\n    }\n\n    /**\n     * Get the main billing report.\n     * @param month Date object for the year and month you want a report from\n     * @param filepath Optional. If specified, the destination to write the billing report to.\n     * @returns Promise of string. The json string for the billing report.\n     */\n    public getReportOverview(month: Date, filepath?: string): Promise<string>;\n    /**\n     * Get the main billing report.\n     * @param month Date object for the year and month you want a report from\n     * @param filepath Optional. If specified, the destination to write the billing report to.\n     * @param callback\n     */\n    public getReportOverview(month: Date, filepath?: string, callback?: CallbackFn<string>): void;\n    public getReportOverview(month: Date, filepath?: string, callback?: CallbackFn<string>): Promise<string> {\n        if (typeof filepath === \"function\") {\n            callback = filepath;\n        }\n\n        return apiWrapper(resultsFn => {\n            this._endpoints.billing.getBillingReport(dateToBillingMonth(month), resultsFn);\n        }, (data, done) => {\n            const string = JSON.stringify(data);\n            if (typeof window === \"undefined\") {\n                // we're in node\n                if (filepath) {\n                    writeFile(filepath, string, \"utf8\", error => {\n                        if (error) {\n                            return done(new SDKError(error.message), null);\n                        }\n                        return done(null, string);\n                    });\n                }\n            } else {\n                done(null, string);\n            }\n        }, callback);\n    }\n\n    /**\n     * Get the active devices report.\n     * @param month Date object for the year and month you want a report from\n     * @param filepath Optional. If specified, the destination to write the billing report to.\n     * @returns Promise of string. The json string for the billing report.\n     */\n    public getReportActiveDevices(month: Date, filepath?: string): Promise<string>;\n    /**\n     * Get the active devices report.\n     * @param month Date object for the year and month you want a report from\n     * @param filepath Optional. If specified, the destination to write the billing report to.\n     * @param callback\n     */\n    public getReportActiveDevices(month: Date, filepath?: string, callback?: CallbackFn<string>): void;\n    public getReportActiveDevices(month: Date, filepath?: string, callback?: CallbackFn<string>): Promise<string> {\n        if (typeof filepath === \"function\") {\n            callback = filepath;\n        }\n\n        return apiWrapper(resultsFn => {\n            this._endpoints.billing.getBillingReportActiveDevices(dateToBillingMonth(month), resultsFn);\n        }, (data: BillingReportRawDataResponse, done) => {\n            this.streamToFile(filepath, data.url, done);\n        }, callback);\n    }\n\n    /**\n     * Get the firmware update report.\n     * @param month Date object for the year and month you want a report from\n     * @param filepath Optional. If specified, the destination to write the billing report to.\n     * @returns Promise of string. The json string for the billing report.\n     */\n    public getReportFirmwareUpdates(month: Date, filepath?: string): Promise<string>;\n    /**\n     * Get the firmware update report.\n     * @param month Date object for the year and month you want a report from\n     * @param filepath Optional. If specified, the destination to write the billing report to.\n     * @param callback\n     */\n    public getReportFirmwareUpdates(month: Date, filepath?: string, callback?: CallbackFn<string>): void;\n    public getReportFirmwareUpdates(month: Date, filepath?: string, callback?: CallbackFn<string>): Promise<string> {\n        if (typeof filepath === \"function\") {\n            callback = filepath;\n        }\n\n        return apiWrapper(resultsFn => {\n            this._endpoints.billing.getBillingReportFirmwareUpdates(dateToBillingMonth(month), resultsFn);\n        }, (data: BillingReportRawDataResponse, done) => {\n            this.streamToFile(filepath, data.url, done);\n        }, callback);\n    }\n\n    /**\n     * Get the service packages in order: pending -> active -> all pending\n     * @returns Promise with Array of ServicePackages\n     */\n    public getServicePackages(): Promise<Array<ServicePackage>>;\n    /**\n     * Get the service packages in order: pending -> active -> all pending\n     * @param callback\n     */\n    public getServicePackages(callback: CallbackFn<Array<ServicePackage>>): void;\n    public getServicePackages(callback?: CallbackFn<Array<ServicePackage>>): Promise<Array<ServicePackage>> {\n        return apiWrapper(resultsFn => {\n            this._endpoints.billing.getServicePackages(resultsFn);\n        }, (data: ServicePackagesResponse, done) => {\n            const list: Array<ServicePackage> = new Array();\n            if (data) {\n                if (data.pending) {\n                    list.push(mapPending(data.pending));\n                }\n                if (data.active) {\n                    list.push(mapActive(data.active));\n                }\n                if (data.previous) {\n                    data.previous.forEach(p => list.push(mapPrevious(p)));\n                }\n            }\n            done(null, list);\n        }, callback);\n    }\n\n    /**\n     * Streams content from HTTP url to file path on disk\n     * @param filepath\n     * @param url\n     * @param done callback\n     */\n    private streamToFile(filepath: string, url: string, done: any) {\n        // tslint:disable-next-line:no-console\n        if (typeof window === \"undefined\" && filepath) {\n            // we're in node and want to stream a file\n            const fileStream = createWriteStream(filepath, { flags: \"a+\" });\n            const req = http_get(url);\n            // bugfix: https://github.com/segmentio/superagent-retry/issues/24\n            //         https://github.com/visionmedia/superagent/issues/313\n            req.pipe(fileStream).on(\"finish\", _ => {\n                done(null, url);\n            });\n            req.on(\"error\", error => {\n                done(new SDKError(error.message), null);\n            });\n        } else {\n            done(null, url);\n        }\n    }\n\n    /**\n     * Get all quota history\n     * @param options\n     * @returns Promise with List Response of QuotaHistory\n     */\n    public getQuotaHistory(options?: ListOptions): Promise<ListResponse<QuotaHistory>>;\n    /**\n     * Get all quota history\n     * @param options\n     * @param callback\n     */\n    public getQuotaHistory(options?: ListOptions, callback?: CallbackFn<ListResponse<QuotaHistory>>): void;\n    public getQuotaHistory(options?: any, callback?: CallbackFn<ListResponse<QuotaHistory>>): Promise<ListResponse<QuotaHistory>> {\n        options = options || {};\n\n        if (typeof options === \"function\") {\n            callback = options;\n        }\n\n        return apiWrapper(resultsFn => {\n            const { limit, after } = options;\n            this._endpoints.billing.getServicePackageQuotaHistory(limit, after, resultsFn);\n        }, (data: ServicePackageQuotaHistoryResponse, done) => {\n            let keys: Array<QuotaHistory>;\n            if (data && data.data && data.data.length) {\n                keys = data.data.map(key => {\n                    return mapQuotaHistory(key);\n                });\n            }\n\n            done(null, new ListResponse<QuotaHistory>(data, keys));\n        }, callback);\n    }\n\n    /**\n     * Get your remaining quota\n     * @returns Promise of number\n     */\n    public getQuotaRemaining(): Promise<number>;\n    /**\n     * Get your remaining quota\n     * @param callback\n     */\n    public getQuotaRemaining(callback: CallbackFn<number>): void;\n    public getQuotaRemaining(callback?: CallbackFn<number>): Promise<number> {\n        return apiWrapper(resultsFn => {\n            this._endpoints.billing.getServicePackageQuota(resultsFn);\n        }, (data: ServicePackageQuota, done) => {\n            if (data) {\n                return done(null, data.quota);\n            }\n        }, callback);\n    }\n}\n"],"sourceRoot":"../../src"}